<!DOCTYPE html><html><head><title>项目中的Canvas brush</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><link rel="shortcut icon" type="image/x-icon" href="/image/logo.jpg"><link rel="stylesheet" href="/css/index.css"><meta name="keywords" content="Canvas,Html5,"><meta name="description" content=""><script src="/js/jquery.min.js"></script><script src="/js/index.js"></script><script src="/js/fancybox.umd.js"></script><script src="/js/fancybox-images.js"></script><script src="/js/gitalk.min.js"></script><script src="/js/hljs.min.js"></script><script>hljs.highlightAll()</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="header"><div class="header-top" id="header-top"><div class="h-left"><a href="/"><img src="/image/loading.gif" data-original="/image/header.png" alt="Quiet"></a></div><div class="h-right"><ul><li><a href="/">HOME</a><span class="dot"></span></li><li><a href="/archives">ARCHIVE</a><span class="dot"></span></li><li><a href="/tags">TAGS</a><span class="dot"></span></li><li><a href="/about">ABOUT ME</a><span class="dot"></span></li></ul></div><div class="h-right-close"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(68,68,68,1)"/></svg></div></div></div><div class="sidebar"><div class="topo"><h2>Jesslyn wongkayan</h2></div><ul><li><a href="/">HOME</a></li><li><a href="/archives">ARCHIVE</a></li><li><a href="/tags">TAGS</a></li><li><a href="/about">ABOUT ME</a></li></ul><div class="my_foot"><a target="_blank" rel="noopener" href="https://github.com/Jesslynwong"><img src="/image/loading.gif" data-original="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quiet主题"></a></div></div><div class="shelter"></div><style>.shelter{background-color:#333;opacity:.5;cursor:pointer;display:none;position:fixed;left:0;top:0;right:0;bottom:0;z-index:1998}.sidebar{width:66%;height:100%;position:fixed;top:0;right:-100%;bottom:0;background:#fff;z-index:1999;text-align:center;box-shadow:-6px 0 20px rgba(98,94,94,.815)}.topo{width:100%;height:200px;background:url(https://api.ixiaowai.cn/gqapi/gqapi.php) no-repeat;background-size:100% 100%;position:relative;display:flex;align-items:flex-end}.topo h2{color:#fff;z-index:1;position:relative;margin:0 0 10px 10px;font-size:1.2em;box-sizing:border-box}.topo:before{content:'';background-image:url(/image/pattern.png);background-repeat:repeat;height:100%;left:0;position:absolute;top:0;width:100%;z-index:1}.sidebar ul{width:100%;margin-top:50px}.sidebar ul li{height:50px;list-style:none;font-size:1.2em;text-align:right;margin-right:10px}.sidebar ul li a{display:grid;color:#5d606a;text-overflow:ellipsis;width:100%;text-decoration:none}.my_foot{width:100%;padding:10px;margin-bottom:10px;position:absolute;bottom:0}.my_foot a{text-decoration:none;margin-right:10px;display:inline-block}.my_foot a img{width:30px;height:30px}</style><script>$(function(){$(".h-right-close>svg").click(function(){$(".sidebar").animate({right:"0"},500),$(".shelter").fadeIn("slow")}),$(".shelter").click(function(e){$(".sidebar").animate({right:"-100%"},500),$(".shelter").fadeOut("slow")})})</script><div class="post"><div class="post-header-background post-header-img" style="background:url(https://api.ixiaowai.cn/gqapi/gqapi.php)"><div class="post-header-background-content"><ul class="post-header-tag"><li><a href="/tags/Canvas">Canvas</a></li><li><a href="/tags/Html5">Html5</a></li></ul><h1>项目中的Canvas brush</h1><div class="post-header-info"><div class="post-header-info-author"><svg t="1604839279282" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2901" width="20" height="20"><path d="M513 956.3c-247.7 0-448-200.3-448-448S265.3 66.2 513 66.2s448 200.3 448 448-200.3 442.1-448 442.1zm0-830.9c-212.2 0-388.8 170.7-388.8 388.8C124.2 726.3 294.9 903 513 903c212.2 0 388.8-170.7 388.8-388.8S725.2 125.4 513 125.4zm0 430.2c-94.2 0-170.7-76.5-170.7-170.7S418.8 207.8 513 207.8s170.7 76.5 170.7 170.7S607.2 555.6 513 555.6zm0-289.1c-64.6 0-112 52.8-112 112s47.4 117.9 112 117.9 112-52.8 112-112-47.4-117.9-112-117.9zm0 689.8c-135.7 0-259-58.7-341.9-158.9l-11.8-17.8 11.8-17.8c76.5-117.9 206.2-188.5 347.8-188.5 135.7 0 265 64.6 341.9 182.6l11.8 17.8-11.8 17.8C778 897.1 648.7 956.3 513 956.3zM230.3 773.2C300.9 849.7 406.9 897 513 897c112 0 218.1-47.4 288.6-129.8-70.5-88.2-170.7-135.6-282.7-135.6s-218.1 53.3-288.6 141.6z" p-id="2902" fill="#ffffff"></path></svg> <span class="post-header-info-author-text"><a target="_blank" rel="noopener" href="https://jesslynwong.github.io/about">Jesslyn</a></span><div class="post-header-info-author-categories"></div><p>2022-10-24 16:33:36</p></div></div></div></div><div class="post-content" id="content"><div id="article" class="post-content-info"><h2 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h2><ol><li>brush 标注出 shape</li><li>选中所选的 shape</li><li>移动当前所选 shape</li></ol><h2 id="所遇问题以及解决方法"><a href="#所遇问题以及解决方法" class="headerlink" title="所遇问题以及解决方法"></a>所遇问题以及解决方法</h2><h4 id="问题1-当-brush-在-canvas-上画的时候，总是进行每一帧的不断重绘。重绘的整个过程，底层不仅仅是把当前-brush-的地方给绘制，而且还会把之前通过-brush-过的地方进行重绘。如此一来，当标注的地方越来越多的时候，计算得越来越多，canvas-性能损耗越来越大，此时会出现闪屏的情况。"><a href="#问题1-当-brush-在-canvas-上画的时候，总是进行每一帧的不断重绘。重绘的整个过程，底层不仅仅是把当前-brush-的地方给绘制，而且还会把之前通过-brush-过的地方进行重绘。如此一来，当标注的地方越来越多的时候，计算得越来越多，canvas-性能损耗越来越大，此时会出现闪屏的情况。" class="headerlink" title="问题1: 当 brush 在 canvas 上画的时候，总是进行每一帧的不断重绘。重绘的整个过程，底层不仅仅是把当前 brush 的地方给绘制，而且还会把之前通过 brush 过的地方进行重绘。如此一来，当标注的地方越来越多的时候，计算得越来越多，canvas 性能损耗越来越大，此时会出现闪屏的情况。"></a>问题1: 当 brush 在 canvas 上画的时候，总是进行每一帧的不断重绘。重绘的整个过程，底层不仅仅是把当前 brush 的地方给绘制，而且还会把之前通过 brush 过的地方进行重绘。如此一来，当标注的地方越来越多的时候，计算得越来越多，canvas 性能损耗越来越大，此时会出现闪屏的情况。</h4><p>解决办法：进行多图层操作。</p><div style="width:325px;height:275px;margin-left:50%;transform:translateX(-50%)"><img src="/image/loading.gif" data-original="https://cdn.jsdelivr.net/gh/Jesslynwong/Pics@main/20221026142506.png" style="display:block"></div><p>此时把 canvas 分成 cluster 层和 active 层。cluster 层主要放的 brush 完形成的标注。active 层主要放的是当前笔刷画的标注。</p><p>当画完当前标注完后，对应画完的图形放到了从 active 层放到了 cluster 层。通过 requestAnimationFrame 把所有标注的图像数据绘制到cluster 层。</p><h4 id="问题2-如何把不同-brush-出来的图形，进行合成。"><a href="#问题2-如何把不同-brush-出来的图形，进行合成。" class="headerlink" title="问题2: 如何把不同 brush 出来的图形，进行合成。"></a><strong>问题2:</strong> 如何把不同 brush 出来的图形，进行合成。</h4><p>合成不外乎就是两种方法，一种是 drawImage 另一种是 通过 putImageData。接下来分析两种方法。以下想了两种方法：</p><p>结论先行：把所有 active 图层下绘制好的 shape 获取 imageData，把 imageData 用缓存存下来，合成的时候，利用 imageData 形成离屏 canvas，通过离屏 canvas，drawImage</p><p><img src="/image/loading.gif" data-original="https://cdn.jsdelivr.net/gh/Jesslynwong/Pics@main/20221026150243.png"></p><blockquote><p>drawImage: 绘制到上下文的元素。允许任何的画布图像源，例如：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLImageElement"><code>HTMLImageElement</code></a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/SVGImageElement"><code>SVGImageElement</code> (en-US)</a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLVideoElement"><code>HTMLVideoElement</code></a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLCanvasElement"><code>HTMLCanvasElement</code></a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/ImageBitmap"><code>ImageBitmap</code></a>、<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/OffscreenCanvas"><code>OffscreenCanvas</code></a> 或 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/VideoFrame"><code>VideoFrame</code> (en-US)</a>。</p></blockquote><p>putImageData（不可行）原因如下:</p><ol><li>Shape 像素覆盖问题：getImageData和putImageDataList，但是出现不了合成情况，两个imageData的每一个pixcel像素只能选择一个新的像素呈现。问题在于也需要合成，也就是说，当 shape 有重合部分的时候，当前像素只能显示其中一个的 shape 对应的像素，无法完全展示两个不同的 shape。</li><li>globalComposite 的合成效果行不通。 复合模式 globalComposite 不会影响 putImageData。putImageData 是比较低级别的。因为putImageData 只是直接替换生成的位图上的像素。</li></ol><blockquote><p>较低级别的意思是它绕过上下文和它用来改变用其他方法（翻译、样式等）绘制的东西的参数 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/18927109/does-globalcompositeoperation-source-over-work-with-putimagedata">https://stackoverflow.com/questions/18927109/does-globalcompositeoperation-source-over-work-with-putimagedata</a></p></blockquote><ol start="3"><li>对比 putImageData 和 drawImage 的效率，《HTML5 Canvas 核心技术》</li></ol><p><img src="/image/loading.gif" data-original="https://cdn.jsdelivr.net/gh/Jesslynwong/Pics@main/20221026151701.png"></p><h4 id="问题3-brush出来的在-active层-效果太粗，使得图片看得不清晰，使得标注有偏差。"><a href="#问题3-brush出来的在-active层-效果太粗，使得图片看得不清晰，使得标注有偏差。" class="headerlink" title="问题3: brush出来的在 active层 效果太粗，使得图片看得不清晰，使得标注有偏差。"></a><strong>问题3:</strong> brush出来的在 active层 效果太粗，使得图片看得不清晰，使得标注有偏差。</h4><p>奇怪的是同样的合成效果是 source-over，active 层画出来的会更粗一些，而cluster 层画出来的透明度是正常的。这个问题至今还不知道什么原因。有朋友知道的可以留言告诉我。</p><p>于是 active 层效果用了 xor，让原本颜色变得稍微透明些。cluster 层用 source-over，使得最近画的 shape 盖在上面</p><div style="width:325px;height:310px;margin-left:50%;transform:translateX(-50%)"><img src="/image/loading.gif" data-original="https://cdn.jsdelivr.net/gh/Jesslynwong/Pics@main/20221026160612.png" style="display:block;height:310px"></div><p><img src="/image/loading.gif" data-original="https://cdn.jsdelivr.net/gh/Jesslynwong/Pics@main/20221026160645.png"></p><h4 id="问题4-：绘制图案好了之后，如果需要移动某个-shape，如何选中当前点击的-shape-呢？"><a href="#问题4-：绘制图案好了之后，如果需要移动某个-shape，如何选中当前点击的-shape-呢？" class="headerlink" title="问题4 ：绘制图案好了之后，如果需要移动某个 shape，如何选中当前点击的 shape 呢？"></a><strong>问题4</strong> ：绘制图案好了之后，如果需要移动某个 shape，如何选中当前点击的 shape 呢？</h4><p>对于这个问题，可以分解为以下三个子问题：</p><ol><li>点击位置是否在图形里面</li><li>怎么知道点击位置选中哪个 shape？</li><li>遇到点击坐标存在重合图形的时候，选中优先级怎么安排？</li></ol><p>碰撞检测算法检测两个图形是否出现碰撞。解决这个问题，可以类比碰撞检测算法。实际上需要计算一个点是否与 shape 出现碰撞。</p><blockquote><p>碰撞检测算法：外接图形（矩形、圆）、光线投射法、分离轴定理（不同角度判断投影是否有重叠）——《html5 canvas核心技术》</p></blockquote><p>brush 形状不是规整的固定，因此对于以上算法，可行性不大。最好是通过像素计算来判断。于是有以下做法解决上面三个子问题</p><ul><li>是否选中和选中哪个： 根据imageData索引判断透明度 &gt; 0</li><li>优先级：如果有多个选中，那么绘制后的选中（优先级机制，需要与产品进行讨论出来）</li></ul><p>优点： 思路最直接、结果最准确、而且对图形形状没有任何要求的方法</p><p>缺点：当图形需要在画布上移动时，要频繁的创建数据缓存才能保证检测结果准确，受到画布尺寸和图形数量的影响， getImageData() 方法的性能会成为严重的瓶颈。所以如果canvas图形是静态的，这个方法非常适合，否则就不适合用这个方法了。</p><p>当图形的填充颜色完全透明时，这种检测方法就会失效，需要做一些特殊的处理。Create.js 的解决方案是给这个透明图形绑定一个大小一致的不透明的图形，用这个图形来做检测。</p></div><div id="gitalk-container"></div></div><script>Fancybox.bind('[data-fancybox="fancybox-gallery-img"]', {
  dragToClose: true,
  Toolbar: true,
  closeButton: "top",
  Image: {
    zoom: true,
  },
  on: {
    initCarousel: (fancybox) => {
      const slide = fancybox.Carousel.slides[fancybox.Carousel.page];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
    "Carousel.change": (fancybox, carousel, to, from) => {
      const slide = carousel.slides[to];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
  },
});</script><style>#noneimg img{display:none;z-index:9999;min-width:0;max-width:90%;max-height:80%;border-radius:0;position:fixed;box-shadow:0 0 0 #c3c3c300!important;left:0;top:0;right:0;bottom:0;margin:auto!important}@media screen and (max-width:600px){#noneimg img{max-width:88%}}</style><div class="post-paging"><a href="/2022/09/28/optimization/"><div class="post-paging-next"><span>下一篇</span><p>前端性能优化</p></div></a></div></div><div class="footer"><div class="Copyright">©2022 By Jesslyn wongkayan.</div><div class="contact"><a target="_blank" rel="noopener" href="https://github.com/Jesslynwong"><img src="/image/loading.gif" data-original="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quiet主题"></a></div></div><script src="/js/gotop.js"></script><style>@media screen and (min-width:600px){.goTop>span{display:flex;align-items:center;justify-content:center;border-radius:10px;width:40px;height:40px;cursor:pointer;opacity:.8;background:rgba(18,24,58,.06);text-align:center;transition:border .5s;border:1px solid rgba(18,24,58,.06);-moz-transition:border .5s;-webkit-transition:border .5s;-o-transition:border .5s}.goTop>span:hover{border:1px solid #6680b3}.goTop{position:fixed;right:30px;bottom:80px}.goTop>span>svg{width:20px;height:20px;opacity:.7}}@media screen and (max-width:600px){.goTop{display:none}}</style><div class="goTop" id="js-go_top"><span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g><path d="M13 12v8h-2v-8H4l8-8 8 8z"></path></g></svg></span></div><script>$("#js-go_top").gotoTop({offset:500,speed:300,animationShow:{transform:"translate(0,0)",transition:"transform .5s ease-in-out"},animationHide:{transform:"translate(100px,0)",transition:"transform .5s ease-in-out"}})</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?4b5fe1472f22fadsfs";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>const data = '{"clientID":"8c7e2048c78b8bc2a849","clientSecret":"011c69973020c48e4bc0f897b4f7d54f04ea84a5","repo":"jesslynwong.github.io","owner":"Jesslynwong","admin":"Jesslynwong"}'
        const gitalk = new Gitalk({
            ...JSON.parse( data),
            id:location.pathname,
            distractionFreeMode:false
        })
        
        if(Boolean('true')){
            gitalk.render('gitalk-container')
        }</script><script>console.log("\n %c Hexo-Quiet 主题 %c https://github.com/79e/hexo-theme-quiet \n","color: #fadfa3; background: #030307; padding:5px 0;","background: #fadfa3; padding:5px 0;")</script><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var t,r=0;r<c.length;r++)0<=(t=(t=c[r]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n()},e.src=i}()}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this)</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script></body></html>